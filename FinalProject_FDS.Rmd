---
title: "Visualization, Time-series Analysis and Community Detection on CitiBike"
output: 
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
  html_notebook:
    fig_caption: yes
    highlight: pygments
    number_sections: yes
    theme: flatly
    toc: yes
author: "Yun Yan (yy1533@nyu.edu), Willian Zhang (willian@nyu.edu)"
---

```{r setup, echo=T, include=FALSE}
knitr::opts_chunk$set(echo=T, error=F, warning=F, message=F)
```

# Goal

We have the following general questions to ask:

- Is there any specific purpose of people to use CitiBike?
- Can we find a robust approach to indirectly study the hidden preference of human activities which cannot be directly observed.

# Why Citibike trip data

Here are three main reasons to select CitiBike trip data:

1. Throughout the semester the course introduced many data science method, e.g. regression, clustering, time-series analysis, NLP, and network analysis, etc, we are looking for a wonderful dataset which would allow us try the methods as many as possible.
2. The context covered by the dataset should not be unfamiliar to students, hence the solutions to challenges can be shared and have actual meanings in real life.
3. The volume of dataset should be small, though we don't require big data. In the same time, the format of data should be not dirty so that we can spend most of time on selecting appropriate method, tuning the parameters of algorithms, and examing the results to generate interpretations that make sense.

# Tech details before running the RMD

## Compile this RMD

Run the following command in terminal:

```bash
Rscript -e "rmarkdown::render('FinalProject_FDS.Rmd')"
```

## Set-up and dependencies
```{r}
WORKDIR <- getwd()
FIGDIR <- file.path(WORKDIR, 'fig')
SRCDIR <- file.path(WORKDIR, 'src')
DATADIR <- file.path(WORKDIR, 'data')
if (!dir.exists(FIGDIR)) dir.create(FIGDIR)
if (!dir.exists(SRCDIR)) dir.create(SRCDIR)
if (!dir.exists(DATADIR)) dir.create(DATADIR)

library('dplyr')
library('reshape2')
library('ggplot2')
library('lubridate')
library('readr')
library('scales')
library('cowplot')
library('forecast')
library('pheatmap')
library('ggmap')
library('igraph')

#theme_set(theme_bw(base_size = 12))
myGthm <- theme(text = element_text(size = 15),
                legend.position='bottom')
```

# Download or import data

Citibike data source is <https://s3.amazonaws.com/tripdata/index.html>. Here I provided a bash script to download and unzip data. 

If you would like to run from scratch, please run following commands in ternimal:

```bash
# go to work-directory of project (same as this RMD file)
cd . 
# create data folder
mkdir -p data 
cd ./src
sh get_data.sh
```

If successful, citibike trip dataset is available at folder data to be read in.
```{r}
infile <- list.files(path=file.path(getwd(), 'data'), pattern='*.csv',
                     full.names = T)
```

```r
data <- bind_rows(lapply(infile, function(x) {
  read.csv(x, stringsAsFactors=FALSE)}))
```

Alternatively, I have attached a RDS file which is exactly same as the above. Load the RDS file if you don't want to download and avoid time on importing data.

```r
data <- readRDS(file.path(DATADIR, 'citibike.rds'))
```
```{r}
data <- read.csv(infile[1], stringsAsFactors = F)
data <- sample_frac(data, 0.1)
```

# Data formatting

## Time

The time information in raw data should be converted to time format recognized by R language.

```{r}
data$startTimestamp <- as.POSIXct(strptime(data$starttime, '%m/%d/%Y %H:%M',
                                           tz = 'EST5EDT'))
data$stopTimestamp  <- as.POSIXct(strptime(data$stoptime, '%m/%d/%Y %H:%M',
                                           tz = 'EST5EDT'))
data$startweekday <- factor(weekdays(data$startTimestamp),
                            levels= c("Sunday", "Monday","Tuesday",
                                      "Wednesday", "Thursday", "Friday",
                                      "Saturday"))
data$stopweekday <- factor(weekdays(data$stopTimestamp),
                            levels= c("Sunday", "Monday","Tuesday",
                                      "Wednesday", "Thursday", "Friday",
                                      "Saturday"))
data$startHr <- format(data$startTimestamp, '%H')
data$stopHr <- format(data$stopTimestamp, '%H')
```

## Longitude / Latitude
```{r}
start_lat_min <- min(data$start.station.latitude)
start_lat_max <- max(data$start.station.latitude)
start_lon_min <- min(data$start.station.longitude)
start_lon_max <- max(data$start.station.longitude)

plot_lat_bt  <- start_lat_min - 2
plot_lat_up  <- start_lat_max + 2
plot_lon_lft <- start_lon_min - 2
plot_lon_rit <- start_lon_max + 2
```

---
**The below are results**

# Visualizing trips to infer hidden pattern of biker preference

Before I applied methods to analyze the data, it is essential to **see** the data. My philosophy is that if there are something playing important role, either itself or its consequences should also have high chances to be observed. Therefore, in order to investigate whether there exists hidden pattern of human activities, it is worthwhile to visualize the dataset at first to explore the properties contained behind dataset.

```{r}
q <-
  qmplot(start.station.longitude, start.station.latitude,
         data = data, maptype = "toner-lite",
         geom = "blank", zoom = 14,
         legend = "right") +
  ggtitle('Pick-up') +
  stat_density_2d(aes(fill = ..level..),
                  geom = "polygon", alpha = .3, color = NA) +
  scale_fill_gradient2("Activities",
                       low = "ghostwhite", mid = "yellow", high = "red")
```

## Picking activity of Usertype (One-time Customer v.s. Member)
```{r}
## Only Usertype (2 types)
q1 <- q + facet_wrap( ~ usertype)
print(q1)
```

## Picking activity of Week ~ Usertype
```{r}
q2 <- q + facet_wrap(startweekday ~ usertype, ncol=8)
print(q2)
```

## Picking activity in 24-hour of Member only during Weekdays

```{r}
subscriber <- data[data$usertype == 'Subscriber', ]

## One-day at NYC (weekdays and weekends)
weekdays_idx <- subscriber$startweekday %in% c("Monday","Tuesday",
                                               "Wednesday", "Thursday", "Friday")
weekends_idx <- !weekdays_idx
subscriberWday <- subscriber[weekdays_idx, ]
subscriberWend <- subscriber[weekends_idx, ]
qSubWday <-
  qmplot(start.station.longitude, start.station.latitude,
         data = subscriberWday, maptype = "toner-lite",
         geom = "blank", zoom = 14,
         legend = "right") +
  stat_density_2d(aes(fill = ..level..),
                  geom = "polygon", alpha = .3, color = NA) +
  scale_fill_gradient2("Pick-Up Activities",
                       low = "ghostwhite", mid = "yellow", high = "red")

qSubWday2 <- qSubWday + facet_wrap(~startHr, ncol=8)
print(qSubWday2)
```

## Conclusions from visualization

In first figure where picking activities all the time for Customer v.s. Member is displayed, it can be found that one-time customers pick up bikes without preferences, while the members have enriched regions, for example the station at 8th Ave & W 31 St, which is cloest to Penn Station. It implies the existence of specific reason to use CitiBike, i.e. members tend to ride for daily commuting while one-time customers ride for fun.

Furthermore, in the second figure where additional comparison on weedays is displayed, it further supports the implication because the highlighted regions of members are stable and one-time customers are still present everywhere.

Finally, by increasing the temporal resolution to hourly, the exact hours when activities of members are enriched can be found. In the early morning (6, 7, 8 AM, i.e. rush hour in the morning) the enriched regions fired up; they faded away during the day until the nightfall. At nightfall (5, 6 PM i.e. rush-hour), the enriched regions showed up again.

In sum, there are two messages inferred by data visualization:

1. There are hidden pattern of people to use CitiBike.
2. Due to the hidden pattern of human activities, different station has its own temporal profile. For example, they have different rush-hours in terms of picking and docking.


# Identify subgroups of stations in terms of temporal profiles

```{r}
set.seed(1234)
## Long-format to wide-format of citybike
citibike_long2wide <- function(data, activity_type = c('pick', 'dock')){
  if (activity_type == 'pick') {
    station_24hr_long <- dplyr::select(data, start.station.name, startHr)
  } else if (activity_type == 'dock') {
    station_24hr_long <- dplyr::select(data, end.station.name, stopHr)
  } else {
    stop('Error: activity type is either pick or dock.')
  }
  colnames(station_24hr_long) <- c('NAME', 'HOUR')
  station_24hr_long <- group_by(station_24hr_long, NAME, HOUR) %>%
    summarise(TRIPS=n())
  station_24hr_wide <- dcast(station_24hr_long, NAME~HOUR,
                             value.var = 'TRIPS', sum, fill=0)
  rownames(station_24hr_wide) <- station_24hr_wide$NAME
  station_24hr_wide <- station_24hr_wide[, -1]
  return(station_24hr_wide)
}
pick_station_24hr <- citibike_long2wide(data=data, activity_type='pick')
dock_station_24hr <- citibike_long2wide(data=data, activity_type='dock')
```

```{r}
orderbyRowSum <- function(data){
  o <- mutate(data, SUM=rowSums(data), row_names=rownames(data)) %>%
    dplyr::arrange(desc(SUM), row_names) %>%
    dplyr::select(-SUM)
  rownames(o) <- o$row_names
  o <- dplyr::select(o, -row_names)
  return(o)
}
top_N <- 20
pick_station_24hr_desc <- orderbyRowSum(pick_station_24hr)
dock_station_24hr_desc <- orderbyRowSum(dock_station_24hr)
top_pick_station_names <- rownames(pick_station_24hr_desc)[seq_len(top_N)]
top_dock_station_names <- rownames(dock_station_24hr_desc)[seq_len(top_N)]
desc_pick_station_names <- rownames(pick_station_24hr_desc)
desc_dock_station_names <- rownames(dock_station_24hr_desc)
```
```{r}
pheatmap(pick_station_24hr_desc[top_pick_station_names, ],
         cluster_rows = F, cluster_cols = F,
         main='Picking activities of Stations with Top 24-hr Picking Activities')
pheatmap(dock_station_24hr_desc[top_pick_station_names, ],
         cluster_rows = F, cluster_cols = F,
         main='Docking activities of Stations with Top 24-hr Picking Activities')
```















